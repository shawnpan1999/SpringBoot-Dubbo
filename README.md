## 1. 设计

### 1.1 总体架构

![](http://psw.life/imgCloud/img/SpringBoot-Dubbo.png)

### 1.2 微服务模块结构

![](http://psw.life/imgCloud/img/modules.jpg)

#### 1.2.1 控制层后端 controller-consumer

控制层后端在 8080 端口为用户提供网页接口；并充当网关，使用拦截器对接口调用进行鉴权与拦截。

在整个系统微服务架构中，控制层后端充当服务消费者的角色，通过服务注册中心对已注册的服务进行 RPC 调用。

#### 1.2.2 用户服务 user-provider

用户服务是一个服务提供者，提供包括登录、登出、注册、登录状态校验的服务功能。服务暴露端口为 20880。

#### 1.2.3 商品服务 product-provider

商品服务是一个服务提供者，提供包括创建、查询、删除商品等服务功能。服务暴露端口为 20881。

#### 1.2.4 订单服务 order-provider

订单服务是一个服务提供者，提供包括创建订单、付款、完成订单、取消订单、删除订单等服务功能。服务暴露端口为 20882。

#### 1.2.5 API 模块 service-api

API 模块定义了其他模块公用的依赖，包括各种实体(用户、商品、订单等)，服务接口以及结果实体 ResultEntity。

### 1.3 接口设计

#### 1.3.1 用户接口

1. 登录

   请求方式：POST

   请求地址：http://localhost:8080/user/login

   请求参数：

   | 参数名   | 类型   | 说明   |
   | -------- | ------ | ------ |
   | username | String | 用户名 |
   | password | String | 密码   |

   返回参数：

   | 参数名 | 类型   | 说明                            |
   | ------ | ------ | ------------------------------- |
   | code   | int    | 状态码，0代表成功，其他为错误码 |
   | msg    | String | 成功/失败信息                   |
   | data   | Map    | 登录对象 ticket 串              |

2. 注册

   请求方式：POST

   请求地址：http://localhost:8080/user/register

   请求参数：

   | 参数名   | 类型   | 说明   |
   | -------- | ------ | ------ |
   | username | String | 用户名 |
   | password | String | 密码   |

   返回参数：

   | 参数名 | 类型   | 说明                                   |
   | ------ | ------ | -------------------------------------- |
   | code   | int    | 状态码，0代表成功，其他为错误码        |
   | msg    | String | 成功/失败信息                          |
   | data   | Map    | 注册对象 ticket 串(以便注册后自动登录) |

3. 登出

   请求方式：GET

   请求地址：http://localhost:8080/logout

   请求后重定向至首页。

#### 1.3.2 商品接口

1. 添加

   请求方式：POST

   请求地址：http://localhost:8080/product/add

   请求参数：

   | 参数名      | 类型   | 说明         |
   | ----------- | ------ | ------------ |
   | productName | String | 商品名       |
   | stock       | int    | 库存         |
   | price       | float  | 单价         |
   | imageUrl    | String | 商品图片地址 |

   返回参数：

   | 参数名 | 类型   | 说明                            |
   | ------ | ------ | ------------------------------- |
   | code   | int    | 状态码，0代表成功，其他为错误码 |
   | msg    | String | 成功/失败信息                   |
   | data   | Map    | 包含创建的对象实体              |

2. 商品陈列

   请求方式：GET

   请求地址：http://localhost:8080/product/lsit

   返回参数：

   | 参数名 | 类型   | 说明                            |
   | ------ | ------ | ------------------------------- |
   | code   | int    | 状态码，0代表成功，其他为错误码 |
   | msg    | String | 成功/失败信息                   |
   | data   | Map    | 包含前10个商品的对象列表        |

#### 1.3.3 订单接口

1. 创建

   请求方式：POST

   请求地址：http://localhost:8080/order/create

   请求参数：

   | 参数名    | 类型 | 说明     |
   | --------- | ---- | -------- |
   | userId    | int  | 用户id   |
   | productId | int  | 商品id   |
   | amount    | int  | 购买数量 |

   返回参数：

   | 参数名 | 类型   | 说明                            |
   | ------ | ------ | ------------------------------- |
   | code   | int    | 状态码，0代表成功，其他为错误码 |
   | msg    | String | 成功/失败信息                   |
   | data   | Map    | 包含创建的订单实体              |

2. 陈列

   请求方式：POST

   请求地址：http://localhost:8080/order/list

   请求参数：

   | 参数名 | 类型 | 说明   |
   | ------ | ---- | ------ |
   | userId | int  | 用户id |

   返回参数：

   | 参数名 | 类型   | 说明                            |
   | ------ | ------ | ------------------------------- |
   | code   | int    | 状态码，0代表成功，其他为错误码 |
   | msg    | String | 成功/失败信息                   |
   | data   | Map    | 包含该用户的订单列表            |

3. 付款

   请求方式：POST

   请求地址：http://localhost:8080/order/pay

   请求参数：

   | 参数名 | 类型 | 说明   |
   | ------ | ---- | ------ |
   | id     | int  | 订单id |

   返回参数：

   | 参数名 | 类型   | 说明                            |
   | ------ | ------ | ------------------------------- |
   | code   | int    | 状态码，0代表成功，其他为错误码 |
   | msg    | String | 成功/失败信息                   |

4. 完成订单

   请求方式：POST

   请求地址：http://localhost:8080/order/finish

   请求参数：

   | 参数名 | 类型 | 说明   |
   | ------ | ---- | ------ |
   | id     | int  | 订单id |

   返回参数：

   | 参数名 | 类型   | 说明                            |
   | ------ | ------ | ------------------------------- |
   | code   | int    | 状态码，0代表成功，其他为错误码 |
   | msg    | String | 成功/失败信息                   |

5. 取消

   请求方式：POST

   请求地址：http://localhost:8080/order/cancel

   请求参数：

   | 参数名 | 类型 | 说明   |
   | ------ | ---- | ------ |
   | id     | int  | 订单id |

   返回参数：

   | 参数名 | 类型   | 说明                            |
   | ------ | ------ | ------------------------------- |
   | code   | int    | 状态码，0代表成功，其他为错误码 |
   | msg    | String | 成功/失败信息                   |

6. 删除

   请求方式：POST

   请求地址：http://localhost:8080/order/delete

   请求参数：

   | 参数名 | 类型 | 说明   |
   | ------ | ---- | ------ |
   | id     | int  | 订单id |

   返回参数：

   | 参数名 | 类型   | 说明                            |
   | ------ | ------ | ------------------------------- |
   | code   | int    | 状态码，0代表成功，其他为错误码 |
   | msg    | String | 成功/失败信息                   |

### 1.4 模块依赖

<img src="http://psw.life/imgCloud/img/module_dependency.png" style="zoom: 50%;" />

service-api 模块包含了其他所有模块的公共依赖，是依赖图中的最底层。

三个服务 user-provider、product-provider、order-provider 是服务的提供者，位于中层，在启动顺序上应先于服务的消费者。

服务消费者 controller-consumer 应在其他三个服务均启动完毕后再开始运行。

### 1.5 部署设计

本系统使用 Docker 容器来部署注册中心、控制模块与各服务。

本系统将 Dubbo-Admin 与 Zookeeper 整合在一个容器中，将容器中的 2181 端口映射在服务器的 2082 端口上。

在测试环境中，三个服务模块和一个控制模块可以在本地直接运行测试。

在实际运行环境中，三个服务模块和一个控制模块将制作为 Docker 镜像，以支持分布式部署。

## 2. 部署环境

### 2.1 操作系统及JRE

CentOS 7 或 Windows 10

JRE 1.8

### 2.2 数据库

MySQL 5.7.29

### 2.3 部署环境

Docker 19.03.12

